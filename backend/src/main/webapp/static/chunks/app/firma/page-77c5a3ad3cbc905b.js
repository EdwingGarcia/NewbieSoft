(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[326],{63:(e,t,r)=>{"use strict";var o=r(7260);r.o(o,"usePathname")&&r.d(t,{usePathname:function(){return o.usePathname}}),r.o(o,"useRouter")&&r.d(t,{useRouter:function(){return o.useRouter}}),r.o(o,"useSearchParams")&&r.d(t,{useSearchParams:function(){return o.useSearchParams}})},1733:(e,t,r)=>{"use strict";r.d(t,{JR:()=>o,ff:()=>n});let o="";async function n(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=e.startsWith("/")?e:"/".concat(e),n="".concat(o).concat(r),a=await fetch(n,{...t,headers:{"Content-Type":"application/json",...t.headers}});if(!a.ok){let e=await a.text();throw Error("Error ".concat(a.status,": ").concat(e||a.statusText))}try{return await a.json()}catch(e){return null}}},6222:(e,t,r)=>{Promise.resolve().then(r.bind(r,8557))},8557:(e,t,r)=>{"use strict";r.d(t,{default:()=>c});var o=r(5155),n=r(2115),a=r(63),i=r(1733);function c(){var e,t,r,c;let s=(0,a.useSearchParams)(),l=(0,a.useRouter)(),d=s.get("ordenId"),u=s.get("modo"),[h,m]=(0,n.useState)(null),[f,p]=(0,n.useState)(!0),b=(0,n.useRef)(null),[x,g]=(0,n.useState)(!1);(0,n.useEffect)(()=>{let e=b.current;if(!e)return;let t=e.getContext("2d");t&&(t.lineWidth=2,t.lineCap="round",t.strokeStyle="#000")},[]),(0,n.useEffect)(()=>{if(!d)return void p(!1);(async()=>{let e=localStorage.getItem("token");if(!e){alert("No tienes sesi\xf3n iniciada."),p(!1);return}try{let t=await fetch("".concat(i.JR,"/api/ordenes/").concat(d,"/detalle"),{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)}});if(!t.ok){if(401===t.status)throw Error("Sesi\xf3n expirada o inv\xe1lida");throw Error("No se pudo cargar la orden")}let r=await t.json();m(r)}catch(e){var t;console.error("ERROR CARGANDO ORDEN:",e),alert(null!=(t=null==e?void 0:e.message)?t:"Error cargando orden")}finally{p(!1)}})()},[d]);let v=e=>{let t=b.current;if(!t)return;let r=t.getContext("2d");if(!r)return;g(!0);let o=t.getBoundingClientRect(),n="touches"in e?e.touches[0].clientX:e.clientX,a="touches"in e?e.touches[0].clientY:e.clientY;r.beginPath(),r.moveTo(n-o.left,a-o.top)},w=e=>{if(!x)return;let t=b.current;if(!t)return;let r=t.getContext("2d");if(!r)return;let o=t.getBoundingClientRect(),n="touches"in e?e.touches[0].clientX:e.clientX,a="touches"in e?e.touches[0].clientY:e.clientY;r.lineTo(n-o.left,a-o.top),r.stroke()},j=()=>g(!1),R=async()=>{var e;if(!h)return;let t=localStorage.getItem("token");if(!t)return void alert("Tu sesi\xf3n ha expirado. Por favor inicia sesi\xf3n nuevamente.");let r=b.current;if(!r)return;let o=r.toDataURL("image/png"),n={ordenId:h.ordenId,numeroOrden:h.numeroOrden,cliente:h.clienteNombre,equipo:null!=(e=h.equipoModelo)?e:h.equipoId,procedimiento:h.problemaReportado,modo:u,firma:o};try{let e=await fetch("".concat(i.JR).concat("recibo"===u?"/api/firmas/recibo":"/api/firmas/conformidad"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(t)},body:JSON.stringify(n)});if(!e.ok)throw Error("Error HTTP ".concat(e.status));let r=await e.blob(),o=window.URL.createObjectURL(r),a=document.createElement("a");a.href=o,a.download="".concat("recibo"===u?"Recibo":"Conformidad","_OT_").concat(h.ordenId,".pdf"),a.click(),window.URL.revokeObjectURL(o),alert("✅ Firma registrada y PDF generado correctamente"),l.push("/dashboard")}catch(e){console.error(e),alert("❌ Error al procesar la firma. Revisa la consola.")}};return f?(0,o.jsx)("div",{className:"p-6 text-center text-lg",children:"Cargando informaci\xf3n..."}):h?(0,o.jsxs)("div",{className:"flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4",children:[(0,o.jsx)("h1",{className:"text-3xl font-bold mb-6",children:"recibo"===u?"Firma de Recibo Conforme":"Confirmaci\xf3n de Procedimiento"}),(0,o.jsxs)("div",{className:"bg-white shadow-md rounded-lg p-6 w-full max-w-md text-center",children:[(0,o.jsxs)("p",{children:[(0,o.jsx)("b",{children:"Equipo:"})," ",null!=(t=null!=(e=h.equipoModelo)?e:h.equipoId)?t:"-"]}),(0,o.jsxs)("p",{children:[(0,o.jsx)("b",{children:"Procedimiento:"})," ",null!=(r=h.problemaReportado)?r:"-"]}),(0,o.jsxs)("p",{children:[(0,o.jsx)("b",{children:"Cliente:"})," ",null!=(c=h.clienteNombre)?c:"-"]}),(0,o.jsx)("div",{className:"mt-4",children:(0,o.jsx)("label",{className:"block mb-2",children:"recibo"===u?"Firma de recibo conforme (servicio entregado)":"\xbfEst\xe1 de acuerdo con el procedimiento propuesto?"})}),(0,o.jsxs)("div",{className:"mt-4",children:[(0,o.jsx)("p",{className:"mb-2",children:(0,o.jsx)("b",{children:"Firma digital:"})}),(0,o.jsx)("canvas",{ref:b,width:350,height:150,className:"border border-gray-400 bg-white rounded-md shadow-sm mx-auto touch-none",onMouseDown:v,onMouseMove:w,onMouseUp:j,onMouseLeave:j,onTouchStart:v,onTouchMove:w,onTouchEnd:j})]}),(0,o.jsxs)("div",{className:"flex justify-between mt-4",children:[(0,o.jsx)("button",{onClick:()=>{let e=b.current;if(!e)return;let t=e.getContext("2d");t&&t.clearRect(0,0,e.width,e.height)},className:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600",type:"button",children:"Limpiar"}),(0,o.jsx)("button",{onClick:R,className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",type:"button",children:"Finalizar y Enviar"})]})]})]}):(0,o.jsx)("div",{className:"p-6 text-center text-red-600",children:"No se pudo cargar la informaci\xf3n de la orden o no tienes permisos."})}}},e=>{e.O(0,[441,255,358],()=>e(e.s=6222)),_N_E=e.O()}]);