name: CI/CD DevSecOps Pipeline - NewbieSoft

on:
  push:
    branches: [ "feature/devsecops-pipeline", "main" ]
  pull_request:
    branches: [ "main" ]

env:
  DOCKER_IMAGE_NAME: newbiesoft-backend
  # Force UTF-8 encoding to avoid MalformedInputException in Maven resources plugin
  MAVEN_OPTS: "-Dfile.encoding=UTF-8"
  LANG: "C.UTF-8"
  
jobs:
  # ------------------------------------------------------------------
  # ETAPA 1: BUILD & TEST (Backend Java + Frontend React)
  # ------------------------------------------------------------------
  build-and-test:
    name: Build and Test (Java & Node)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del código
        uses: actions/checkout@v3

      # --- BACKEND (Java Spring Boot) ---
      - name: Configurar JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Dar permisos de ejecución a Maven Wrapper
        run: chmod +x backend/mvnw

      - name: Construir Backend con Maven
        run: |
          cd backend
          # Added -Dfile.encoding=UTF-8 explicitly to the command as well
          ./mvnw clean package -DskipTests -Dfile.encoding=UTF-8

      # --- FRONTEND (Next.js) ---
      - name: Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Instalar dependencias Frontend
        run: |
          cd frontend
          npm ci --legacy-peer-deps

      - name: Build Frontend
        continue-on-error: true
        run: |
          cd frontend
          npm run build --if-present

  # ------------------------------------------------------------------
  # ETAPA 2: SEGURIDAD (DevSecOps - SAST/SCA)
  # ------------------------------------------------------------------
  security-scan-code:
    name: Security Analysis (SAST/SCA)
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Checkout del código
        uses: actions/checkout@v3

      - name: Escaneo de vulnerabilidades con Trivy (Filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          format: 'table'
          exit-code: '0' 
          severity: 'CRITICAL,HIGH'

  # ------------------------------------------------------------------
  # ETAPA 3: EMPAQUETADO Y ESCANEO DE IMAGEN (Backend)
  # ------------------------------------------------------------------
  build-push-image:
    name: Build Docker Image & Scan
    runs-on: ubuntu-latest
    needs: security-scan-code
    steps:
      - name: Checkout del código
        uses: actions/checkout@v3

      - name: Configurar JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: Generar JAR
        run: |
          chmod +x backend/mvnw
          cd backend
          ./mvnw clean package -DskipTests -Dfile.encoding=UTF-8

      - name: Construir imagen Docker (Backend)
        run: |
          cd backend
          docker build -t ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} .

      - name: Escaneo de imagen Docker con Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

  # ------------------------------------------------------------------
  # ETAPA 4: DESPLIEGUE CONTINUO E INFRAESTRUCTURA (Monitoreo)
  # ------------------------------------------------------------------
  deploy-infrastructure:
    name: Deploy App & Monitoring
    runs-on: ubuntu-latest
    needs: build-push-image
    steps:
      - name: Checkout del código
        uses: actions/checkout@v3

      - name: Simular Despliegue App (Kubernetes)
        run: |
          echo "Conectando al clúster K8s..."
          echo "Desplegando nueva versión de backend: ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}"
          echo "Aplicación actualizada."

      # NUEVO PASO: Despliegue automatizado de Grafana/Prometheus
      - name: Desplegar Stack de Monitoreo (Docker Compose)
        run: |
          echo "Iniciando despliegue de observabilidad..."
          # En un entorno real, esto se ejecutaría via SSH en el servidor de producción
          # Aquí validamos que la configuración sea correcta levantándolo en el runner
          docker-compose up -d
          
          echo "Verificando estado de los contenedores..."
          docker ps
          
          echo "Grafana desplegado en puerto 3000."
          echo "Prometheus desplegado en puerto 9090."